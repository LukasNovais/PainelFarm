<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Tribal Wars</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f4f6f9;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      background: #2c3e50;
      color: white;
      padding: 15px;
      text-align: center;
      flex-shrink: 0;
    }
    .main-container {
      display: flex;
      flex-grow: 1;
    }
    nav {
      background: #34495e;
      color: white;
      width: 220px;
      flex-shrink: 0;
      padding-top: 20px;
    }
    nav button {
      width: 100%;
      border: none;
      background: none;
      color: white;
      padding: 15px 20px;
      text-align: left;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.3s;
      border-bottom: 1px solid #4a627a;
    }
    nav button:hover, nav button.active {
      background: #1abc9c;
    }
    .content {
      flex-grow: 1;
      overflow-y: auto;
      padding: 20px;
    }
    section {
      display: none;
    }
    section.active {
      display: block;
    }
    .card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    input, button, textarea, select {
      padding: 8px;
      margin: 5px 0;
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    button.action {
      background: #1abc9c;
      color: white;
      border: none;
      cursor: pointer;
      transition: background 0.3s;
      width: auto;
    }
    button.action:hover {
      background: #16a085;
    }
    .button-group {
      display: flex;
      gap: 10px;
    }
    .button-group button {
      flex: 1;
    }
    ul {
      margin: 10px 0;
      padding-left: 20px;
    }
    .analise-card {
      background-color: #e8f5e9;
      border-left: 5px solid #1abc9c;
      padding: 15px;
      margin-top: 20px;
    }
    .analise-card h3 {
      margin-top: 0;
      color: #2c3e50;
    }
    .analise-card p {
      margin: 5px 0;
    }
    .analise-card ul {
      margin: 10px 0;
      padding-left: 20px;
    }
    .world-select-group {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .world-select-group label {
      width: auto;
    }
  </style>
</head>
<body>

  <header>
    <h1>Dashboard Tribal Wars</h1>
    <p>Ferramenta de estrat√©gia e planejamento</p>
  </header>

  <div class="main-container">
    <nav>
      <button class="active" onclick="showTab('farm')">‚öîÔ∏è Farm</button>
      <button onclick="showTab('estrategia')">üõ°Ô∏è Estrat√©gia</button>
      <button onclick="showTab('analise')">üìä An√°lise</button>
      <button onclick="showTab('plano')">üìù Plano de Ataque</button>
    </nav>

    <div class="content">
      <section id="farm" class="active">
        <div class="card">
          <h2>Calculadora de Farm</h2>
          <label>Sua pontua√ß√£o:<br>
            <input type="number" id="meusPontos">
          </label>
          <label>Sua coordenada (ex: 500|500):<br>
            <input type="text" id="minhaCoord">
          </label>
          <label>Pontua√ß√£o da aldeia alvo:<br>
            <input type="number" id="alvoPontos">
          </label>
          <label>Coordenada da aldeia alvo (ex: 510|495):<br>
            <input type="text" id="alvoCoord">
          </label>
          <label>Tipo da aldeia:<br>
            <select id="tipoAldeia">
              <option value="barbara">B√°rbara</option>
              <option value="bonus">B√¥nus</option>
            </select>
          </label>
          <div class="button-group">
            <button class="action" onclick="calcularFarm()">Calcular Farm</button>
            <button class="action" onclick="limparResultado('farmResult')">Limpar</button>
          </div>
          <div id="farmResult" style="margin-top:15px;"></div>
        </div>
        <div class="card">
          <h2>Encontre Farms Pr√≥ximos</h2>
          <p>1. Selecione o mundo abaixo.</p>
          <p>2. Clique em **An√°lise do Mundo** para extrair os dados do jogo.</p>
          <p>3. Clique no bot√£o para processar e encontrar as aldeias mais pr√≥ximas.</p>
          <div class="world-select-group">
              <label for="farmWorldSelect">Selecione o Mundo:</label>
              <select id="farmWorldSelect">
                  <option value="136">Mundo 136</option>
                  <option value="137">Mundo 137</option>
              </select>
          </div>
          <label>Sua Coordenada (ex: 500|500):
            <input type="text" id="minhaCoord2">
          </label>
          <div class="button-group">
            <button class="action" onclick="encontrarFarmsProximos()">Encontrar Aldeias</button>
            <button class="action" onclick="limparResultado('proximosResult')">Limpar</button>
          </div>
          <div id="proximosResult" style="margin-top:15px;"></div>
        </div>
      </section>

      <section id="estrategia">
        <div class="card">
          <h2>Treinador Estrat√©gico</h2>
          <label>Sua pontua√ß√£o atual:<br>
            <input type="number" id="estratMeusPontos">
          </label>
          <div class="button-group">
            <button class="action" onclick="gerarGuiaTreinamento()">Gerar Guia de Treinamento</button>
            <button class="action" onclick="limparResultado('guiaTreinamento')">Limpar</button>
          </div>
        </div>
        <div id="guiaTreinamento" class="analise-card" style="display: none;"></div>
      </section>

      <section id="analise">
        <div class="card">
          <h2>An√°lise de Dados do Mundo</h2>
          <p>Siga os passos para coletar os dados:</p>
          <ol>
              <li>Entre no seu mundo do Tribal Wars.</li>
              <li>V√° para **Classifica√ß√£o** e clique em **Aldeias**.</li>
              <li>V√° para **Classifica√ß√£o** e clique em **Jogadores**.</li>
              <li>V√° para **Classifica√ß√£o** e clique em **Tribos**.</li>
              <li>Depois de visitar as 3 p√°ginas, clique em **Processar An√°lise**.</li>
          </ol>
          <div class="button-group" style="margin-top: 20px;">
            <button class="action" onclick="processarAnalise()">Processar An√°lise</button>
          </div>
          <div id="analiseResultados" style="margin-top: 15px;"></div>
        </div>
      </section>

      <section id="plano">
        <div class="card">
          <h2>Plano de Ataque Detalhado</h2>
          <p>1. Selecione seu mundo.</p>
          <p>2. Clique em **An√°lise do Mundo** para extrair os dados do jogo.</p>
          <p>3. Insira sua coordenada para encontrar os alvos mais pr√≥ximos e clique em "Gerar Plano de Ataque".</p>
          <div class="world-select-group">
              <label for="planoWorldSelect">Selecione o Mundo:</label>
              <select id="planoWorldSelect">
                  <option value="136">Mundo 136</option>
                  <option value="137">Mundo 137</option>
              </select>
          </div>
          <label>Sua Coordenada (ex: 500|500):
            <input type="text" id="minhaCoordPlano">
          </label>
          <div class="button-group">
            <button class="action" onclick="gerarPlanoAtaque()">Gerar Plano de Ataque</button>
            <button class="action" onclick="limparResultado('planoAtaqueResult')">Limpar</button>
          </div>
          <div id="planoAtaqueResult" style="margin-top: 15px;"></div>
        </div>
      </section>
    </div>
  </div>

  <script>
    const tropas = {
      lanceiro: { nome: "Lanceiro", carga: 25 },
      espada: { nome: "Espadachim", carga: 15 },
      leve: { nome: "Infantaria Leve", carga: 80 },
      pesada: { nome: "Cavalaria Pesada", carga: 50 }
    };

    const guias = {
      'iniciante': {
        titulo: "Fase Inicial (At√© 500 pontos)",
        estrategia: "Foco total em crescimento r√°pido e farm. Priorize a produ√ß√£o de recursos para alimentar o crescimento da sua primeira aldeia.",
        tropasDefesa: "Construa at√© 500 lanceiros para uma defesa b√°sica. S√£o eficientes contra cavalaria e farm pesados.",
        tropasAtaque: "Comece com 200 Cavalaria Leve. Eles s√£o ideais para farm de aldeias b√°rbaras e alvos fracos, por sua velocidade e capacidade de carga.",
        planoEvolucao: [
          "Edif√≠cio Principal Nv 15 (Para acelera√ß√£o da constru√ß√£o)",
          "Quartel Nv 5 (Para treinar infantaria)",
          "Est√°bulo Nv 1 (Para treinar Cavalaria Leve)",
          "Madeira, Argila e Ferro Nv 15-20 (Para manter o fluxo de recursos)",
          "Fazenda Nv 20 (Para suportar mais tropas)"
        ]
      },
      'basico': {
        titulo: "Meio de Jogo (500 - 1.000 pontos)",
        estrategia: "Fortale√ßa sua defesa e inicie o ataque a aldeias de outros jogadores. Aumente o ex√©rcito para farmar alvos com mais recursos e se preparar para as pr√≥ximas conquistas.",
        tropasDefesa: "Mantenha a defesa com 1000 Lanceiros e adicione 500 Espadachins.",
        tropasAtaque: "Crie uma ofensiva com 1000 Cavalaria Leve, 200 Ar√≠etes e 50 Catapultas. Este √© um grupo forte para ataques a jogadores com poucas defesas.",
        planoEvolucao: [
          "Muralha Nv 10 (Para defesa estrat√©gica)",
          "Est√°bulo Nv 10 (Para acelerar o treinamento de cavalaria)",
          "Oficina Nv 5 (Para Ar√≠etes e Catapultas)",
          "Ponto de Encontro Nv 10 (Para planejar ataques m√∫ltiplos e enviar mais tropas)",
          "Feira Nv 10 (Para trocar recursos e financiar o crescimento)"
        ]
      },
      'intermediario': {
        titulo: "Ataque e Noblagem (1.000 - 4.000 pontos)",
        estrategia: "Esta √© a fase de expans√£o. Foque em construir um ex√©rcito de ataque completo e comece a conquistar sua primeira aldeia, al√©m de continuar o farm agressivo.",
        tropasDefesa: "Construa uma defesa massiva de 5.000 Espadachins para defender a sua primeira aldeia. Mantenha 1.000 lanceiros para suporte.",
        tropasAtaque: "Ataque com uma for√ßa de noblagem: 10.000 Cavalaria Leve, 1.000 Ar√≠etes e 500 Catapultas. Esse ex√©rcito √© capaz de quebrar defesas e abrir caminho para o nobre.",
        planoEvolucao: [
          "Academia Nv 1 (Para a noblagem)",
          "Oficina Nv 15 (Para produ√ß√£o r√°pida de Ar√≠etes e Catapultas)",
          "Muralha Nv 20 (Para prote√ß√£o m√°xima contra noblagens)",
          "Sede Nv 20 (Para acelerar constru√ß√µes e noblagens)"
        ]
      },
      'avancado': {
        titulo: "Fase Avan√ßada (4.000+ pontos)",
        estrategia: "Voc√™ se tornou um jogador forte. O foco agora √© na cria√ß√£o de aldeias especializadas (ataque, defesa e farm) e na coordena√ß√£o de ataques e defesas com sua tribo para dominar o mapa.",
        tropasDefesa: "Aumente as defesas para 10.000 Lanceiros e 10.000 Espadachins. Pense em criar aldeias de defesa dedicadas (com b√¥nus de defesa e muralhas altas).",
        tropasAtaque: "Mantenha um ex√©rcito principal com mais de 5.000 Cavalaria Leve para farm e foque na produ√ß√£o de cavalaria pesada para noblagens em massa. Pelo menos 10.000 de cada.",
        planoEvolucao: [
          "Constru√ß√£o de uma segunda aldeia com foco em ataque",
          "N√≠veis de edif√≠cios de recursos maximizados",
          "Coordena√ß√£o com a tribo para ataques e defesas"
        ]
      }
    };

    function showTab(tabId) {
      document.querySelectorAll("section").forEach(sec => sec.classList.remove("active"));
      document.querySelectorAll("nav button").forEach(btn => btn.classList.remove("active"));
      document.getElementById(tabId).classList.add("active");
      document.querySelector(`[onclick="showTab('${tabId}')"]`).classList.add("active");
    }

    function salvarResultado(id, conteudo) {
      const mundo = getMundoAtual(id);
      if (!mundo) return;
      localStorage.setItem(`${id}-${mundo}`, conteudo);
    }
    
    function salvarDadosBrutos(id, dados) {
      const mundo = getMundoAtual(id);
      if (!mundo) return;
      localStorage.setItem(`${id}-${mundo}`, JSON.stringify(dados));
    }

    function limparResultado(id) {
        const mundo = getMundoAtual(id);
        if (!mundo) return;
        localStorage.removeItem(`${id}-${mundo}`);
        document.getElementById(id).innerHTML = '';
        if (id === 'guiaTreinamento') {
            document.getElementById(id).style.display = 'none';
        }
        alert("Resultado limpo com sucesso!");
    }

    function getMundoAtual(id) {
        if (id.includes('proximosResult')) {
            return document.getElementById('farmWorldSelect').value;
        }
        if (id.includes('analiseResultados')) {
            // Nova l√≥gica para o modo manual
            return document.getElementById('analiseWorldSelect').value;
        }
        if (id.includes('planoAtaqueResult')) {
            return document.getElementById('planoWorldSelect').value;
        }
        return null;
    }

    function processarAnalise() {
        const villageData = localStorage.getItem('tw_scraped_data_village');
        const playerData = localStorage.getItem('tw_scraped_data_player');
        const allyData = localStorage.getItem('tw_scraped_data_ally');
        const resultadosDiv = document.getElementById('analiseResultados');

        if (!villageData || !playerData || !allyData) {
            resultadosDiv.innerHTML = `<p>Dados n√£o encontrados. Visite as p√°ginas de classifica√ß√£o de Aldeias, Jogadores e Tribos no jogo para coletar os dados primeiro.</p>`;
            return;
        }

        const aldeiasAtuais = JSON.parse(villageData);
        const jogadoresAtuais = JSON.parse(playerData);
        const tribosAtuais = JSON.parse(allyData);
        
        const dataKey = `analiseData`;
        const dataSalva = JSON.parse(localStorage.getItem(dataKey)) || {};

        let resultadosHtml = "<h3>Relat√≥rio de An√°lise</h3>";
        
        const playersData = {
            timestamp: Date.now(),
            jogadores: jogadoresAtuais,
            aldeias: aldeiasAtuais,
            tribos: tribosAtuais
        };
        
        if (dataSalva.playersData && dataSalva.playersData.length > 0) {
            const ultimaSessao = dataSalva.playersData[dataSalva.playersData.length - 1];
            const jogadoresAnteriores = ultimaSessao.jogadores;
            const tempoPassado = (playersData.timestamp - ultimaSessao.timestamp) / (1000 * 60 * 60);

            const jogadoresInativos = [];
            const crescimentoJogador = [];

            for (const id in jogadoresAtuais) {
                if (jogadoresAnteriores[id]) {
                    const pontosAnteriores = jogadoresAnteriores[id].pontos;
                    const pontosAtuais = jogadoresAtuais[id].pontos;
                    const mudancaPontos = pontosAtuais - pontosAnteriores;

                    if (mudancaPontos === 0) {
                        jogadoresInativos.push({
                            nome: jogadoresAtuais[id].nome,
                            pontos: pontosAtuais
                        });
                    } else {
                        crescimentoJogador.push({
                            nome: jogadoresAtuais[id].nome,
                            mudanca: mudancaPontos
                        });
                    }
                }
            }
            
            jogadoresInativos.sort((a,b) => b.pontos - a.pontos);
            crescimentoJogador.sort((a,b) => b.mudanca - a.mudanca);

            resultadosHtml += `<h3>An√°lise de Crescimento (√∫ltimas ${tempoPassado.toFixed(1)} horas)</h3>`;
            resultadosHtml += `<h4>Top 10 Jogadores com Maior Crescimento</h4><ol>`;
            crescimentoJogador.slice(0,10).forEach(j => {
                resultadosHtml += `<li>${j.nome} (+${j.mudanca} pts)</li>`;
            });
            resultadosHtml += `</ol>`;

            resultadosHtml += `<h4>Jogadores Inativos (0 pontos de crescimento)</h4><ul>`;
            jogadoresInativos.slice(0, 20).forEach(j => {
                resultadosHtml += `<li>${j.nome} (${j.pontos} pts)</li>`;
            });
            resultadosHtml += `</ul>`;
        } else {
            resultadosHtml += `<p>Cole os dados novamente amanh√£ para ativar a an√°lise de crescimento!</p>`;
        }
        
        if (!dataSalva.playersData) {
            dataSalva.playersData = [];
        }
        dataSalva.playersData.push(playersData);
        localStorage.setItem(dataKey, JSON.stringify(dataSalva));

        const topAldeias = getTopVillages(aldeiasAtuais, jogadoresAtuais);
        const topTribos = getTopTribes(tribosAtuais);
        const melhoresFarms = getBestFarms(aldeiasAtuais);

        resultadosHtml += `<h3>Maiores Aldeias</h3>
            <ol>${topAldeias.map(item => `<li>**${item.nome} (${item.pontos} pts)** - ${item.jogador} - ${item.coords}</li>`).join('')}</ol>
            <h3>Maiores Tribos</h3>
            <ol>${topTribos.map(item => `<li>**${item.nome} (${item.pontos} pts)** - Membros: ${item.membros}</li>`).join('')}</ol>
            <h3>Melhores Alvos de Farm</h3>
            <ol>${melhoresFarms.map(item => `<li>**${item.tipo} (${item.pontos} pts)** - ${item.coords}</li>`).join('')}</ol>
        `;

        resultadosDiv.innerHTML = resultadosHtml;
        localStorage.setItem(`analiseResultados`, resultadosHtml);
    }

    // PLANO DE ATAQUE
    function gerarPlanoAtaque() {
        const mundo = document.getElementById('planoWorldSelect').value;
        const villageData = localStorage.getItem('tw_scraped_data_village');
        const playerData = localStorage.getItem('tw_scraped_data_player');
        const allyData = localStorage.getItem('tw_scraped_data_ally');
        const minhaCoordStr = document.getElementById('minhaCoordPlano').value;
        const planoAtaqueDiv = document.getElementById('planoAtaqueResult');

        if (!villageData || !playerData || !allyData || !minhaCoordStr) {
            alert("Por favor, visite as p√°ginas de classifica√ß√£o de Aldeias, Jogadores e Tribos no jogo para coletar os dados primeiro.");
            return;
        }

        const minhaCoord = minhaCoordStr.split("|").map(Number);
        if (minhaCoord.length !== 2 || isNaN(minhaCoord[0]) || isNaN(minhaCoord[1])) {
            alert("Coordenada inv√°lida! Use o formato: 500|500");
            return;
        }

        const aldeias = JSON.parse(villageData);
        const jogadores = JSON.parse(playerData);
        const tribos = JSON.parse(allyData);

        const alvos = Object.values(aldeias).filter(a => a.jogadorID > 0 || a.jogadorID === 0);
        
        alvos.forEach(aldeia => {
            const distancia = Math.sqrt(Math.pow(minhaCoord[0] - aldeia.x, 2) + Math.pow(minhaCoord[1] - aldeia.y, 2));
            aldeia.distancia = distancia;
            aldeia.jogador = jogadores[aldeia.jogadorID];
            if (aldeia.jogador && aldeia.jogador.allyID) {
                aldeia.tribo = tribos[aldeia.jogador.allyID];
            }
        });

        const alvosProximos = alvos.sort((a, b) => a.distancia - b.distancia).slice(0, 50);

        let htmlResult = "<h3>Plano de Ataque (50 Alvos mais Pr√≥ximos)</h3>";
        htmlResult += "<p>Sugest√µes baseadas na dist√¢ncia e pontua√ß√£o. Sempre espi√£o antes de atacar!</p>";
        
        alvosProximos.forEach(alvo => {
            const recursosEstimados = Math.floor(alvo.pontos * 1.2);
            let qtdLeve = Math.ceil(recursosEstimados / tropas.leve.carga);
            if (qtdLeve < 5) qtdLeve = 5;

            const nomeJogador = alvo.jogador ? alvo.jogador.name : "B√°rbara/B√¥nus";
            const nomeTribo = alvo.tribo ? alvo.tribo.name : "N/A";

            htmlResult += `
                <div>
                    ${alvo.x}|${alvo.y} | 
                    ${alvo.name} (${alvo.points} pts) | 
                    ${nomeJogador} | 
                    ${nomeTribo} | 
                    ${qtdLeve} Cavalaria Leve | 
                    ${alvo.distancia.toFixed(2)} campos
                </div>
            `;
        });
        
        planoAtaqueDiv.innerHTML = htmlResult;
        localStorage.setItem(`planoAtaqueResult-${mundo}`, htmlResult);
    }
    
    // Fun√ß√µes de an√°lise de dados
    function getTopVillages(aldeias, jogadores) {
      const lista = Object.values(aldeias).filter(a => a.player > 0).sort((a, b) => b.points - a.points).slice(0, 50);
      return lista.map(aldeia => ({
        nome: aldeia.name,
        pontos: aldeia.points,
        coords: `${aldeia.x}|${aldeia.y}`,
        jogador: jogadores[aldeia.player] ? jogadores[aldeia.player].name : 'Desconhecido'
      }));
    }

    function getTopTribes(tribos) {
        let tribosComPontos = Object.values(tribos).map(tribo => {
            let totalPontos = 0;
            return {
                ...tribo,
                pontos: tribo.points
            };
        });
        
        return tribosComPontos.sort((a, b) => b.pontos - a.pontos).slice(0, 50);
    }


    function getBestFarms(aldeias) {
      const farms = Object.values(aldeias).filter(a => a.player === 0).sort((a, b) => b.points - a.points).slice(0, 50);
      return farms.map(aldeia => ({
        tipo: 'B√°rbara',
        pontos: aldeia.points,
        coords: `${aldeia.x}|${aldeia.y}`
      }));
    }
    
    window.onload = () => {
        // Nada mais √© necess√°rio para o modo manual
    };
  </script>
</body>
</html>
