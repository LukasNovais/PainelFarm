<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tribal Wars Tools</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #2e2e2e;
            color: #f0f0f0;
            background-image: url('https://www.tribalwars.net/gfx/bg/1600x900.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        .app-container {
            display: flex;
            min-height: 100vh;
        }
        #sidebar {
            width: 250px;
            background-color: rgba(30, 30, 30, 0.9);
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.5);
        }
        #sidebar h2 {
            color: #d4a761;
            text-align: center;
            margin-bottom: 20px;
        }
        .sidebar-item {
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        .sidebar-item:hover {
            background-color: #444;
        }
        .sidebar-item.active {
            background-color: #d4a761;
            color: black;
            font-weight: bold;
        }
        #main-content {
            flex-grow: 1;
            padding: 30px;
            background-color: rgba(0, 0, 0, 0.6);
            overflow-y: auto;
        }
        .content-section {
            display: none;
            background-color: rgba(30, 30, 30, 0.9);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }
        .content-section.active {
            display: block;
        }
        h1 {
            text-align: center;
            color: #d4a761;
            text-shadow: 2px 2px 4px #000;
        }
        .section {
            margin-bottom: 25px;
        }
        .input-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }
        .input-group label {
            margin-bottom: 5px;
            font-weight: bold;
        }
        .input-group input[type="number"], .input-group textarea, .input-group input[type="text"], .input-group select, .input-group input[type="datetime-local"] {
            padding: 10px;
            border: 1px solid #555;
            border-radius: 5px;
            background-color: #3a3a3a;
            color: #f0f0f0;
            resize: vertical;
        }
        .buttons-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
            text-decoration: none;
            color: white;
        }
        .btn-primary {
            background-color: #4a90e2;
        }
        .btn-primary:hover {
            background-color: #357bd8;
        }
        .btn-secondary {
            background-color: #d4a761;
            color: black;
        }
        .btn-secondary:hover {
            background-color: #c09653;
        }
        .results-container {
            margin-top: 30px;
        }
        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 10px;
        }
        .tab-btn {
            padding: 10px 20px;
            border: none;
            background-color: #2e2e2e;
            color: #aaa;
            cursor: pointer;
            font-weight: bold;
            transition: color 0.3s, background-color 0.3s;
            border-bottom: 3px solid transparent;
        }
        .tab-btn:hover {
            color: #fff;
        }
        .tab-btn.active {
            background-color: #3a3a3a;
            color: #fff;
            border-bottom: 3px solid #d4a761;
        }
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9em;
        }
        .results-table th, .results-table td {
            padding: 8px;
            border: 1px solid #555;
            text-align: left;
        }
        .results-table th {
            background-color: #2e2e2e;
            cursor: pointer;
        }
        .results-table tr:nth-child(even) {
            background-color: #242424;
        }
        .results-table tr:hover {
            background-color: #444;
        }
        .results-table th.sorted-asc::after {
            content: ' ▲';
        }
        .results-table th.sorted-desc::after {
            content: ' ▼';
        }
        #sort-tip {
            text-align: center;
            font-size: 0.9em;
            color: #d4a761;
            margin-bottom: 10px;
        }
        .analysis-btn {
            padding: 5px 10px;
            background-color: #4a90e2;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .analysis-btn:hover {
            background-color: #357bd8;
        }
        .attack-analysis, .strategy-analysis, .travel-time-result, .attack-planner-result {
            margin-top: 20px;
            padding: 20px;
            background-color: #3a3a3a;
            border-radius: 5px;
            border: 1px solid #d4a761;
        }
        .attack-analysis h3, .strategy-analysis h3, .travel-time-result h3, .attack-planner-result h3 {
            margin-top: 0;
            color: #d4a761;
        }
        .attack-analysis p, .strategy-analysis p, .travel-time-result p, .attack-planner-result p {
            margin: 5px 0;
        }
        .attack-planner-result p span {
            font-weight: bold;
            color: #d4a761;
        }
    </style>
</head>
<body>

<div class="app-container">
    <div id="sidebar">
        <h2>Menu</h2>
        <div class="sidebar-item active" data-target="analysis-section">Análise</div>
        <div class="sidebar-item" data-target="plan-section">Plano de Ataque / Defesa</div>
        <div class="sidebar-item" data-target="strategy-section">Estratégia por coordenada</div>
    </div>

    <div id="main-content">
        <div id="analysis-section" class="content-section active">
            <div class="container">
                <h1>Análise de Aldeias</h1>
                <div class="section">
                    <div class="input-group">
                        <label for="worldNumber">Número do Mundo:</label>
                        <input type="number" id="worldNumber" placeholder="Ex: 137">
                    </div>
                    <div class="buttons-group" id="downloadGroup">
                        <button class="btn btn-primary" id="downloadButton">Baixar Lista</button>
                    </div>
                </div>
                <div class="section">
                    <div class="input-group">
                        <label for="dataInput">Cole aqui os dados da lista de aldeias:</label>
                        <textarea id="dataInput" rows="3"></textarea>
                    </div>
                    <div class="buttons-group">
                        <button class="btn btn-secondary" id="generateReportButton">Gerar Relatório</button>
                    </div>
                </div>
                <div class="section results-container">
                    <h2>Resultados da Análise</h2>
                    <div class="tabs">
                        <button class="tab-btn active" id="tab-player">Jogadores</button>
                        <button class="tab-btn" id="tab-barbarian">Bárbaros</button>
                        <button class="tab-btn" id="tab-bonus">Bônus</button>
                    </div>
                    <p id="sort-tip">Clique no nome da coluna para ordenar a lista (crescente/decrescente).</p>
                    <div class="input-group">
                        <label for="searchInput">Pesquisar Aldeia:</label>
                        <input type="text" id="searchInput" placeholder="Digite o nome da aldeia">
                    </div>
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th data-column="name">Nome da Aldeia</th>
                                <th data-column="coords">Coordenadas</th>
                                <th data-column="points">Pontos</th>
                                <th data-column="playerId">ID do Jogador</th>
                                <th data-column="rank">Classificação</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="plan-section" class="content-section">
            <div class="container">
                <h1>Plano de Ataque / Defesa</h1>
                <div class="section">
                    <div class="input-group">
                        <label for="userCoords">Suas Coordenadas (X|Y):</label>
                        <input type="text" id="userCoords" placeholder="Ex: 500|500">
                    </div>
                    <div class="input-group">
                        <label for="searchRadius">Raio de Busca:</label>
                        <input type="number" id="searchRadius" placeholder="Ex: 10">
                    </div>
                    <div class="buttons-group">
                        <button class="btn btn-secondary" id="searchRadiusButton">Buscar no Raio</button>
                    </div>
                </div>
                <div class="section results-container">
                    <h2>Aldeias Próximas</h2>
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Nome da Aldeia</th>
                                <th>Coordenadas</th>
                                <th>Pontos</th>
                                <th>Distância</th>
                                <th>Ação</th>
                            </tr>
                        </thead>
                        <tbody id="radiusTableBody">
                            </tbody>
                    </table>
                </div>
                <div id="attack-analysis-container"></div>
            </div>
        </div>

        <div id="strategy-section" class="content-section">
            <div class="container">
                <h1>Estratégia por Coordenada</h1>
                <div class="section">
                    <div class="input-group">
                        <label for="userVillageCoords">Coordenadas da sua Aldeia (X|Y):</label>
                        <input type="text" id="userVillageCoords" placeholder="Ex: 500|500">
                    </div>
                    <div class="buttons-group">
                        <button class="btn btn-secondary" id="analyzeStrategyButton">Encontrar Aldeias Próximas</button>
                    </div>
                </div>
                 <div class="section results-container">
                    <div class="tabs" id="strategy-tabs" style="display:none;">
                        <button class="tab-btn active" id="strategy-tab-all">Todas</button>
                        <button class="tab-btn" id="strategy-tab-player">Jogadores</button>
                        <button class="tab-btn" id="strategy-tab-barbarian">Bárbaros</button>
                        <button class="tab-btn" id="strategy-tab-bonus">Bônus</button>
                    </div>
                    <h2>Aldeias ao Redor</h2>
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Nome da Aldeia</th>
                                <th>Coordenadas</th>
                                <th>Pontos</th>
                                <th>Distância</th>
                            </tr>
                        </thead>
                        <tbody id="strategyTableBody">
                            </tbody>
                    </table>
                </div>
                
                <div class="section">
                    <h2>Calculadora de Viagem</h2>
                    <div class="input-group">
                        <label for="originCoords">Coordenadas de Origem (X|Y):</label>
                        <input type="text" id="originCoords" placeholder="Ex: 500|500">
                    </div>
                    <div class="input-group">
                        <label for="destinyCoords">Coordenadas de Destino (X|Y):</label>
                        <input type="text" id="destinyCoords" placeholder="Ex: 500|500">
                    </div>
                    <div class="input-group">
                        <label for="troopType">Tipo de Tropa:</label>
                        <select id="troopType">
                            <option value="spear">Lanceiro</option>
                            <option value="sword">Espadachim</option>
                            <option value="axe">Machadeiro</option>
                            <option value="archer">Arqueiro</option>
                            <option value="scout">Explorador</option>
                            <option value="light">Cavalaria Leve</option>
                            <option value="marcher">Arqueiro a Cavalo</option>
                            <option value="heavy">Cavalaria Pesada</option>
                            <option value="ram">Aríete</option>
                            <option value="catapult">Catapulta</option>
                            <option value="snob">Nobre</option>
                        </select>
                    </div>
                    <div class="buttons-group">
                        <button class="btn btn-secondary" id="calculateTimeButton">Calcular Tempo</button>
                    </div>
                    <div id="travelTimeResult" class="travel-time-result" style="display:none;">
                        <h3>Tempo de Viagem</h3>
                        <p id="timeOutput"></p>
                    </div>
                </div>

                <div class="section">
                    <h2>Planejador de Ataque</h2>
                    <div class="input-group">
                        <label for="attackOriginCoords">Coordenadas de Origem (X|Y):</label>
                        <input type="text" id="attackOriginCoords" placeholder="Ex: 500|500">
                    </div>
                    <div class="input-group">
                        <label for="attackDestinyCoords">Coordenadas de Destino (X|Y):</label>
                        <input type="text" id="attackDestinyCoords" placeholder="Ex: 500|500">
                    </div>
                    <div class="input-group">
                        <label for="arrivalTime">Horário de Chegada (Data e Hora):</label>
                        <input type="datetime-local" id="arrivalTime">
                    </div>
                    <div class="buttons-group">
                        <button class="btn btn-secondary" id="planAttackButton">Planejar Ataque</button>
                    </div>
                    <div id="attackPlannerResult" class="attack-planner-result" style="display:none;">
                        <h3>Horários de Partida</h3>
                        <p id="departureTimesOutput"></p>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    let bonusVillages = [];
    let barbarianVillages = [];
    let playerVillages = [];
    
    let allVillages = [];
    let currentVillages = [];
    let sortDirection = {};
    let nearbyVillagesAll = [];

    const troopSpeeds = {
        spear: 18,
        sword: 22,
        axe: 18,
        archer: 18,
        scout: 9,
        light: 10,
        marcher: 10,
        heavy: 11,
        ram: 18,
        catapult: 18,
        snob: 35
    };

    document.querySelectorAll('.sidebar-item').forEach(item => {
        item.addEventListener('click', function() {
            document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
            this.classList.add('active');

            document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
            const targetId = this.getAttribute('data-target');
            document.getElementById(targetId).classList.add('active');
        });
    });

    document.getElementById('downloadButton').addEventListener('click', function() {
        const worldNumber = document.getElementById('worldNumber').value;
        const downloadGroup = document.getElementById('downloadGroup');

        if (worldNumber) {
            const url = `https://br${worldNumber}.tribalwars.com.br/map/village.txt`;
            const newLink = document.createElement('a');
            newLink.href = url;
            newLink.target = "_blank";
            newLink.textContent = "Clique para Copiar a Lista!";
            newLink.classList.add('btn', 'btn-primary');
            
            downloadGroup.innerHTML = '';
            downloadGroup.appendChild(newLink);

        } else {
            alert('Por favor, digite o número do mundo.');
        }
    });

    document.getElementById('generateReportButton').addEventListener('click', function() {
        const data = document.getElementById('dataInput').value;
        if (!data) {
            alert('Por favor, cole os dados antes de gerar o relatório.');
            return;
        }

        const lines = data.split('\n').filter(line => line.trim() !== '');
        
        bonusVillages = [];
        barbarianVillages = [];
        playerVillages = [];

        lines.forEach(line => {
            const parts = line.split(',');
            if (parts.length >= 6) { 
                const villageName = decodeURIComponent(parts[1].replace(/\+/g, ' '));
                const coords = `${parts[2]}|${parts[3]}`;
                const playerId = parseInt(parts[4], 10);
                const points = parseInt(parts[5], 10);
                const rank = parts[6] || 'N/A';

                const village = {
                    name: villageName,
                    coords: coords,
                    points: points,
                    playerId: playerId,
                    rank: rank,
                    x: parseInt(parts[2], 10),
                    y: parseInt(parts[3], 10)
                };
                
                if (playerId === 0) {
                    if (villageName.includes('Aldeia-bonus')) {
                        bonusVillages.push(village);
                    } else {
                        barbarianVillages.push(village);
                    }
                } else {
                    playerVillages.push(village);
                }
            }
        });
        
        currentVillages = playerVillages;
        allVillages = playerVillages;
        displayVillages(currentVillages);
        
        document.getElementById('tab-player').classList.add('active');
        document.getElementById('tab-barbarian').classList.remove('active');
        document.getElementById('tab-bonus').classList.remove('active');
    });

    function displayVillages(villageList) {
        const tableBody = document.getElementById('resultsTableBody');
        tableBody.innerHTML = '';
        
        villageList.forEach(village => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${village.name}</td>
                <td>${village.coords}</td>
                <td>${village.points}</td>
                <td>${village.playerId}</td>
                <td>${village.rank}</td>
            `;
            tableBody.appendChild(row);
        });
    }
    
    document.getElementById('tab-player').addEventListener('click', function() {
        allVillages = playerVillages;
        currentVillages = allVillages;
        displayVillages(currentVillages);
        clearSortIndicators();
        this.classList.add('active');
        document.getElementById('tab-barbarian').classList.remove('active');
        document.getElementById('tab-bonus').classList.remove('active');
        document.getElementById('searchInput').value = '';
    });

    document.getElementById('tab-barbarian').addEventListener('click', function() {
        allVillages = barbarianVillages;
        currentVillages = allVillages;
        displayVillages(currentVillages);
        clearSortIndicators();
        this.classList.add('active');
        document.getElementById('tab-player').classList.remove('active');
        document.getElementById('tab-bonus').classList.remove('active');
        document.getElementById('searchInput').value = '';
    });

    document.getElementById('tab-bonus').addEventListener('click', function() {
        allVillages = bonusVillages;
        currentVillages = allVillages;
        displayVillages(currentVillages);
        clearSortIndicators();
        this.classList.add('active');
        document.getElementById('tab-player').classList.remove('active');
        document.getElementById('tab-barbarian').classList.remove('active');
        document.getElementById('searchInput').value = '';
    });

    document.querySelectorAll('.results-table th').forEach(header => {
        header.addEventListener('click', function() {
            const column = this.dataset.column;
            if (!column) return;
            
            clearSortIndicators(this);
            
            const isNumeric = (column === 'points' || column === 'playerId' || column === 'rank');
            const direction = sortDirection[column] === 'asc' ? 'desc' : 'asc';
            
            currentVillages.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];

                if (isNumeric) {
                    aVal = parseFloat(aVal);
                    bVal = parseFloat(bVal);
                }

                if (aVal < bVal) return direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return direction === 'asc' ? 1 : -1;
                return 0;
            });
            
            sortDirection[column] = direction;
            this.classList.add(`sorted-${direction}`);
            
            displayVillages(currentVillages);
        });
    });

    function clearSortIndicators(activeHeader) {
        document.querySelectorAll('.results-table th').forEach(th => {
            if (th !== activeHeader) {
                th.classList.remove('sorted-asc', 'sorted-desc');
            }
        });
    }

    document.getElementById('searchInput').addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const filteredVillages = allVillages.filter(village => {
            return village.name.toLowerCase().includes(searchTerm);
        });
        currentVillages = filteredVillages;
        displayVillages(currentVillages);
        clearSortIndicators();
    });

    document.getElementById('searchRadiusButton').addEventListener('click', function() {
        if (playerVillages.length === 0) {
            alert('Atenção: A lista de aldeias de jogadores está vazia. Por favor, cole os dados na aba "Análise" e clique em "Gerar Relatório" primeiro.');
            return;
        }

        const userCoordsInput = document.getElementById('userCoords').value;
        const radius = parseInt(document.getElementById('searchRadius').value, 10);
        
        const coordsParts = userCoordsInput.split('|');
        if (coordsParts.length !== 2 || isNaN(parseInt(coordsParts[0], 10)) || isNaN(parseInt(coordsParts[1], 10))) {
            alert('Erro: Por favor, insira as coordenadas no formato X|Y. Ex: 500|500');
            return;
        }

        const userX = parseInt(coordsParts[0], 10);
        const userY = parseInt(coordsParts[1], 10);

        const nearbyVillages = playerVillages.map(village => {
            const distance = calculateDistance(userX, userY, village.x, village.y);
            return { ...village, distance: distance };
        }).filter(village => village.distance <= radius);

        nearbyVillages.sort((a, b) => a.distance - b.distance);

        displayRadiusVillages(nearbyVillages);
    });

    function calculateDistance(x1, y1, x2, y2) {
        return Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
    }

    function displayRadiusVillages(villageList) {
        const tableBody = document.getElementById('radiusTableBody');
        tableBody.innerHTML = '';
        document.getElementById('attack-analysis-container').innerHTML = '';

        if (villageList.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="5">Nenhuma aldeia encontrada no raio especificado.</td></tr>`;
            return;
        }

        villageList.forEach(village => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${village.name}</td>
                <td>${village.coords}</td>
                <td>${village.points}</td>
                <td>${village.distance.toFixed(2)}</td>
                <td><button class="analysis-btn" data-points="${village.points}">Analisar</button></td>
            `;
            tableBody.appendChild(row);
        });

        document.querySelectorAll('.analysis-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const points = parseInt(this.dataset.points, 10);
                displayAttackAnalysis(points);
            });
        });
    }

    function displayAttackAnalysis(points) {
        let difficulty, farmEstimate, troopSuggestion, strategyTip;
        
        if (points < 1000) {
            difficulty = "Muito Fácil";
            farmEstimate = "Provavelmente vazia, ideal para farm rápido.";
            troopSuggestion = "10 lanceiros ou 5 espadachins";
            strategyTip = "Ótima opção para farmar recursos rapidamente e acumular pontos.";
        } else if (points >= 1000 && points < 3000) {
            difficulty = "Fácil";
            farmEstimate = "Pode conter recursos. Ataque regular é a melhor opção.";
            troopSuggestion = "20 a 50 lanceiros ou 10 a 25 espadachins";
            strategyTip = "Boa opção para farm. Se o jogador for inativo, vale a pena atacar com mais tropas.";
        } else if (points >= 3000 && points < 5000) {
            difficulty = "Médio";
            farmEstimate = "Pode ter uma defesa pequena. Use tropas mais fortes ou mais quantidade.";
            troopSuggestion = "50 a 100 lanceiros e 50 espadachins. Pode precisar de Cavalaria Leve.";
            strategyTip = "Considere um ataque de exploração antes para verificar a defesa. Ataques de farm compensam.";
        } else if (points >= 5000 && points < 8000) {
            difficulty = "Difícil";
            farmEstimate = "Provável que tenha uma defesa moderada. Ataque com cavalaria.";
            troopSuggestion = "Use Cavalaria Leve. Quantidade varia com a distância.";
            strategyTip = "Alvo para farm de longo prazo ou para noblar. Considere um ataque de cerco.";
        } else { // pontos >= 8000
            difficulty = "Muito Difícil";
            farmEstimate = "Possível que a defesa seja forte. Ataque com tropas de nobre e apoio.";
            troopSuggestion = "Nobres, Aríetes, Catapultas e tropas de apoio (machadeiros/cavalaria)";
            strategyTip = "Alvo de noblagem. Requer um plano de ataque coordenado e tropas full.";
        }

        const analysisHTML = `
            <h3>Análise do Alvo</h3>
            <p><strong>Dificuldade:</strong> ${difficulty}</p>
            <p><strong>Farm Provável:</strong> ${farmEstimate}</p>
            <p><strong>Sugestão de Tropas:</strong> ${troopSuggestion}</p>
            <p><strong>Estratégia Recomendada:</strong> ${strategyTip}</p>
        `;

        document.getElementById('attack-analysis-container').innerHTML = analysisHTML;
    }

    document.getElementById('analyzeStrategyButton').addEventListener('click', function() {
        if (playerVillages.length === 0 || barbarianVillages.length === 0 || bonusVillages.length === 0) {
            alert('Atenção: A lista de aldeias está vazia. Por favor, cole os dados na aba "Análise" e clique em "Gerar Relatório" primeiro.');
            return;
        }

        const userCoordsInput = document.getElementById('userVillageCoords').value;
        const coordsParts = userCoordsInput.split('|');
        if (coordsParts.length !== 2 || isNaN(parseInt(coordsParts[0], 10)) || isNaN(parseInt(coordsParts[1], 10))) {
            alert('Erro: Por favor, insira as coordenadas no formato X|Y. Ex: 500|500');
            return;
        }

        const userX = parseInt(coordsParts[0], 10);
        const userY = parseInt(coordsParts[1], 10);
        
        nearbyVillagesAll = [...playerVillages, ...barbarianVillages, ...bonusVillages].map(village => {
            const distance = calculateDistance(userX, userY, village.x, village.y);
            return { ...village, distance: distance };
        });

        nearbyVillagesAll.sort((a, b) => a.distance - b.distance);
        
        displayStrategyVillages(nearbyVillagesAll.slice(0, 20));
        
        document.getElementById('strategy-tabs').style.display = 'flex';
        document.getElementById('strategy-tab-all').classList.add('active');
        document.getElementById('strategy-tab-player').classList.remove('active');
        document.getElementById('strategy-tab-barbarian').classList.remove('active');
        document.getElementById('strategy-tab-bonus').classList.remove('active');
    });

    document.getElementById('strategy-tabs').addEventListener('click', function(event) {
        if (event.target.tagName === 'BUTTON') {
            document.querySelectorAll('#strategy-tabs .tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            let filteredList = [];
            const filterType = event.target.id;

            if (filterType === 'strategy-tab-player') {
                filteredList = nearbyVillagesAll.filter(v => v.playerId !== 0).slice(0, 20);
            } else if (filterType === 'strategy-tab-barbarian') {
                filteredList = nearbyVillagesAll.filter(v => v.playerId === 0 && !v.name.includes('Aldeia-bonus')).slice(0, 20);
            } else if (filterType === 'strategy-tab-bonus') {
                filteredList = nearbyVillagesAll.filter(v => v.name.includes('Aldeia-bonus')).slice(0, 20);
            } else {
                filteredList = nearbyVillagesAll.slice(0, 20);
            }
            displayStrategyVillages(filteredList);
        }
    });

    function displayStrategyVillages(villageList) {
        const tableBody = document.getElementById('strategyTableBody');
        tableBody.innerHTML = '';
        if (villageList.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="4">Nenhuma aldeia encontrada para este filtro.</td></tr>`;
            return;
        }
        villageList.forEach(village => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${village.name}</td>
                <td>${village.coords}</td>
                <td>${village.points}</td>
                <td>${village.distance.toFixed(2)}</td>
            `;
            tableBody.appendChild(row);
        });
    }

    // Lógica da Calculadora de Viagem
    document.getElementById('calculateTimeButton').addEventListener('click', function() {
        const originCoordsInput = document.getElementById('originCoords').value;
        const destinyCoordsInput = document.getElementById('destinyCoords').value;
        const troopType = document.getElementById('troopType').value;
        
        const originParts = originCoordsInput.split('|');
        const destinyParts = destinyCoordsInput.split('|');

        if (originParts.length !== 2 || destinyParts.length !== 2 || isNaN(parseInt(originParts[0], 10)) || isNaN(parseInt(originParts[1], 10)) || isNaN(parseInt(destinyParts[0], 10)) || isNaN(parseInt(destinyParts[1], 10))) {
            alert('Erro: Por favor, insira as coordenadas de origem e destino no formato X|Y.');
            return;
        }
        
        const x1 = parseInt(originParts[0], 10);
        const y1 = parseInt(originParts[1], 10);
        const x2 = parseInt(destinyParts[0], 10);
        const y2 = parseInt(destinyParts[1], 10);

        const distance = calculateDistance(x1, y1, x2, y2);
        const troopSpeed = troopSpeeds[troopType];
        
        const worldSpeed = 1; // Pode ser ajustado se o mundo tiver velocidade diferente
        const totalTimeInMinutes = (distance * troopSpeed) / worldSpeed;
        const totalTimeInSeconds = totalTimeInMinutes * 60;

        const hours = Math.floor(totalTimeInSeconds / 3600);
        const minutes = Math.floor((totalTimeInSeconds % 3600) / 60);
        const seconds = Math.floor(totalTimeInSeconds % 60);

        const timeOutput = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        document.getElementById('timeOutput').textContent = timeOutput;
        document.getElementById('travelTimeResult').style.display = 'block';
    });

    // Lógica do Planejador de Ataque
    document.getElementById('planAttackButton').addEventListener('click', function() {
        const originCoordsInput = document.getElementById('attackOriginCoords').value;
        const destinyCoordsInput = document.getElementById('attackDestinyCoords').value;
        const arrivalTimeInput = document.getElementById('arrivalTime').value;

        if (!originCoordsInput || !destinyCoordsInput || !arrivalTimeInput) {
            alert('Erro: Por favor, preencha todas as coordenadas e o horário de chegada.');
            return;
        }
        
        const originParts = originCoordsInput.split('|');
        const destinyParts = destinyCoordsInput.split('|');

        if (originParts.length !== 2 || destinyParts.length !== 2) {
            alert('Erro: Por favor, insira as coordenadas no formato X|Y.');
            return;
        }

        const x1 = parseInt(originParts[0], 10);
        const y1 = parseInt(originParts[1], 10);
        const x2 = parseInt(destinyParts[0], 10);
        const y2 = parseInt(destinyParts[1], 10);

        const distance = calculateDistance(x1, y1, x2, y2);
        const arrivalTime = new Date(arrivalTimeInput);
        
        if (isNaN(arrivalTime.getTime())) {
            alert('Erro: Horário de chegada inválido. Use o formato do campo.');
            return;
        }

        const worldSpeed = 1;
        let outputHTML = '';

        for (const [troop, speed] of Object.entries(troopSpeeds)) {
            const travelTimeInMinutes = (distance * speed) / worldSpeed;
            const travelTimeInMilliseconds = travelTimeInMinutes * 60 * 1000;
            
            const departureTime = new Date(arrivalTime.getTime() - travelTimeInMilliseconds);
            
            const formattedTime = departureTime.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' }) + ' - ' +
                                  departureTime.toLocaleTimeString('pt-BR', { hour12: false });
            
            const troopName = getTroopName(troop);
            outputHTML += `<p><span>${troopName}:</span> ${formattedTime}</p>`;
        }

        document.getElementById('departureTimesOutput').innerHTML = outputHTML;
        document.getElementById('attackPlannerResult').style.display = 'block';
    });

    function getTroopName(key) {
        const names = {
            spear: 'Lanceiro',
            sword: 'Espadachim',
            axe: 'Machadeiro',
            archer: 'Arqueiro',
            scout: 'Explorador',
            light: 'Cavalaria Leve',
            marcher: 'Arqueiro a Cavalo',
            heavy: 'Cavalaria Pesada',
            ram: 'Aríete',
            catapult: 'Catapulta',
            snob: 'Nobre'
        };
        return names[key] || key;
    }
</script>

</body>
</html>
